version: 2

jobs:
  build:
    docker:
      - image: circleci/node:9.2.0
    environment:
      REACT_APP_METAGENSCOPE_SERVICE_URL: http://metagenscope-service
      DISPLAY: ':99.0'

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Install Node modules
          command: |
            npm install --silent

      - run:
          name: Install Docker Compose
          command: |
            set -x
            VER="1.11.2"
            curl -L https://github.com/docker/compose/releases/download/${VER}/docker-compose-`uname -s`-`uname -m` > docker-compose
            chmod +x docker-compose
            sudo mv docker-compose /usr/local/bin

      - setup_remote_docker

      - run:
          name: Build and start containers
          command: |
            set -x
            docker-compose -f docker-compose.yml -f docker-compose.ci.yml up --build -d

      # Run tests!
      - run:
          name: Run tests
          command: |
            set -x
            sh test.sh

      - run:
          name: Stop container
          command: docker-compose down
